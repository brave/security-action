rules:
  - id: github-workflow-missing-permissions
    languages:
      - yaml
    severity: WARNING
    message: |
      GitHub Actions workflow is missing permissions declaration at the top-level or job-level.

      Without explicit permissions, workflows may have excessive default permissions, violating the principle of least privilege.

      According to GitHub's security best practices, you should explicitly define permissions to limit the scope of access tokens.

      Valid permission scopes include: actions, attestations, checks, contents, deployments, discussions, id-token, issues, models, packages, pages, pull-requests, security-events, statuses

      üëç Good examples:

      Top-level: `permissions: { contents: read, pull-requests: write }`
      Job-level: `jobs: build: permissions: { contents: read }`
      Restrict all: `permissions: {}`

      üëé Bad:

      No permissions defined in the workflow

      [GitHub Security Hardening Guide](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token)
    patterns:
      - pattern: |
          on: ...
          ...
          jobs:
            ...
      - pattern-not: |
          permissions: ...
          ...
          on: ...
          ...
          jobs:
            ...
      - pattern-not: |
          on: ...
          ...
          permissions: ...
          ...
          jobs:
            ...
      - pattern-not: |
          on: ...
          ...
          jobs:
            $JOB:
              ...
              permissions: ...
              ...
    metadata:
      author: Andrea Brancaleoni
      cwe:
        - "CWE-250: Execution with Unnecessary Privileges"
        - "CWE-732: Incorrect Permission Assignment for Critical Resource"
      owasp: A01:2021 - Broken Access Control
      references:
        - https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token
        - https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#using-permissions
        - https://owasp.org/Top10/A01_2021-Broken_Access_Control
      source: https://github.com/brave/security-action/blob/main/assets/opengrep_rules/services/github-workflow-missing-permissions.yaml
      category: security
      technology:
        - github-actions
      subcategory:
        - vuln
      likelihood: MEDIUM
      impact: MEDIUM
      confidence: HIGH
      license: Commons Clause License Condition v1.0[LGPL-2.1-only]
      vulnerability_class:
        - Improper Authorization
