name: Update Opengrep Version

on:
  schedule:
    # Run every Monday at 10:00 AM UTC
    - cron: '0 10 * * 1'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  update-opengrep-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '24.x'

      - name: Run opengrep version update script
        id: update
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const path = require('path')
            const updateOpengrepVersion = (await import(path.join(process.cwd(), 'src/updateOpengrepVersion.js'))).default
            const result = await updateOpengrepVersion()

            core.setOutput('updated', result.updated)
            if (result.updated) {
              core.setOutput('old_version', result.oldVersion)
              core.setOutput('new_version', result.newVersion)
            }

      - name: Check for changes and create PR
        if: steps.update.outputs.updated == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create and switch to new branch
          BRANCH_NAME="automated/update-opengrep-version"
          git checkout -b ${BRANCH_NAME}

          # Commit changes
          git add src/installOpengrep.js
          git commit -m "Update opengrep to ${{ steps.update.outputs.new_version }}"

          # Push branch
          git push origin ${BRANCH_NAME} --force

          # Create PR (will fail gracefully if PR already exists)
          gh pr create \
            --title "Update opengrep to ${{ steps.update.outputs.new_version }}" \
            --body "This PR automatically updates opengrep from ${{ steps.update.outputs.old_version }} to ${{ steps.update.outputs.new_version }}.

          ## Changes
          - Updated \`src/installOpengrep.js\` with new version and SHA256 hash

          This PR was automatically generated by the \`update-opengrep-version\` workflow." \
            --base main \
            --head ${BRANCH_NAME} \
            --label dependencies \
            --repo ${GITHUB_REPOSITORY} || echo "PR already exists or could not be created"

      - name: No update needed
        if: steps.update.outputs.updated != 'true'
        run: echo "Opengrep is already up to date"
